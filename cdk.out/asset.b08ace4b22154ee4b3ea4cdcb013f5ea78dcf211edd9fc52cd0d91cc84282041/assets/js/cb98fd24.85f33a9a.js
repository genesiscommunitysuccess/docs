"use strict";(self.webpackChunk_genesislcap_docs=self.webpackChunk_genesislcap_docs||[]).push([[93811],{75405:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return l},default:function(){return c},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return m}});var a=n(87462),i=n(63366),r=(n(67294),n(3905)),o=(n(61839),["components"]),s={title:"Developer training - Day five",sidebar_label:"Day five",sidebar_position:7,id:"training-content-day5",keywords:["getting started","quick start","developer training","day five"],tags:["getting started","quick start","developer training","day five"]},l=void 0,p={unversionedId:"getting-started/developer-training/training-content-day5",id:"version-2022.3/getting-started/developer-training/training-content-day5",title:"Developer training - Day five",description:"Day four recap",source:"@site/versioned_docs/version-2022.3/01_getting-started/06_developer-training/05_training-content-day5.md",sourceDirName:"01_getting-started/06_developer-training",slug:"/getting-started/developer-training/training-content-day5",permalink:"/getting-started/developer-training/training-content-day5",draft:!1,tags:[{label:"getting started",permalink:"/tags/getting-started"},{label:"quick start",permalink:"/tags/quick-start"},{label:"developer training",permalink:"/tags/developer-training"},{label:"day five",permalink:"/tags/day-five"}],version:"2022.3",sidebarPosition:7,frontMatter:{title:"Developer training - Day five",sidebar_label:"Day five",sidebar_position:7,id:"training-content-day5",keywords:["getting started","quick start","developer training","day five"],tags:["getting started","quick start","developer training","day five"]},sidebar:"learningSidebar",previous:{title:"Day four",permalink:"/getting-started/developer-training/training-content-day4"},next:{title:"Introduction",permalink:"/getting-started/server_training/ssdt-intro"}},d={},m=[{value:"Schedulers\u200b",id:"schedulers",level:2},{value:"Cron rules (static events)\u200b",id:"cron-rules-static-events",level:3},{value:"The rule",id:"the-rule",level:4},{value:"1. Configure the Evaluator",id:"1-configure-the-evaluator",level:4},{value:"2. Create a new class",id:"2-create-a-new-class",level:4},{value:"3. Create an event handler",id:"3-create-an-event-handler",level:4},{value:"4.Load the cron rule on to the database",id:"4load-the-cron-rule-on-to-the-database",level:4},{value:"5.Change the log level to verify the execution of the events",id:"5change-the-log-level-to-verify-the-execution-of-the-events",level:4},{value:"Exercise 5.1: using the Evaluator",id:"exercise-51-using-the-evaluator",level:3},{value:"Permissions\u200b",id:"permissions",level:2},{value:"Authorisation",id:"authorisation",level:3},{value:"Users, profiles and right codes",id:"users-profiles-and-right-codes",level:4},{value:"The objective",id:"the-objective",level:3},{value:"Set up generic permissions",id:"set-up-generic-permissions",level:3},{value:"Configure dynamic permissions",id:"configure-dynamic-permissions",level:3},{value:"Permissioning and permissionCodes",id:"permissioning-and-permissioncodes",level:3},{value:"Exercise 5.2: using permissions",id:"exercise-52-using-permissions",level:3},{value:"Application is done!",id:"application-is-done",level:3},{value:"Operating the Genesis low-code platform",id:"operating-the-genesis-low-code-platform",level:2},{value:"Basic file structure",id:"basic-file-structure",level:3},{value:"Key server commands",id:"key-server-commands",level:3},{value:"Practising the commands",id:"practising-the-commands",level:3},{value:"Exercise 5.3: manual deployment of the application distribution",id:"exercise-53-manual-deployment-of-the-application-distribution",level:3},{value:"Navigating the documentation and how to get help\u200b",id:"navigating-the-documentation-and-how-to-get-help",level:2}],u={toc:m};function c(e){var t=e.components,s=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("details",null,(0,r.kt)("summary",null,"Day four recap"),(0,r.kt)("div",null,(0,r.kt)("div",null,"Here are the main takeaways from ",(0,r.kt)("a",{href:"/getting-started/developer-training/training-content-day4/"},"Day four"),"."),(0,r.kt)("li",null,"We implemented a ",(0,r.kt)("a",{href:"/getting-started/developer-training/training-content-day4/#state-management"},"state machine")," to control Trade workflow."),(0,r.kt)("li",null,"We added logic to the Event Handler using the ",(0,r.kt)("a",{href:"/getting-started/developer-training/training-content-day4/#add-the-validation-code"},"onValidate")," block."),(0,r.kt)("li",null,"We implemented basic ",(0,r.kt)("a",{href:"/getting-started/developer-training/training-content-day4/#adding-basic-auditing"},"auditing")," on the Trade table."))),(0,r.kt)("p",null,"This day covers:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#schedulers"},"Schedulers")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#permissions"},"Permissions\u200b")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#operating-the-genesis-platform"},"Operating the platform")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#navigating-the-documentation-and-how-to-get-help%E2%80%8B"},"Navigating the documentation and how to get help\u200b"))),(0,r.kt)("h2",{id:"schedulers"},"Schedulers\u200b"),(0,r.kt)("p",null,"You can use the Evaluator to schedule the production of EOD reports (for example), or to send warnings when a defined limit is breached."),(0,r.kt)("p",null,"In system terms, Evaluators enable you to connect Event Handlers to two different kinds of event: dynamic and static (cron rules): "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Cron Rules"),"  are scheduling rules; these are defined as ",(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Cron#CRON_expression"},"standard cron expression"),". "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Dynamic Rules"),", also known as Dynamic Events, are defined as ",(0,r.kt)("a",{parentName:"li",href:"https://groovy-lang.org/syntax.html"},"groovy expression"),", which respond to changes to database table entries.")),(0,r.kt)("p",null,"In both cases, you define the rule in a table in the database: CRON_RULES for static rules and DYNAMIC_RULES for dynamic rules. In this training, we're going to use Cron Rules, but if you're interested in the Dynamic Rules please look at ",(0,r.kt)("a",{parentName:"p",href:"/server/evaluator/basics/#defining-a-dynamic-rule"},"Defining a dynamic rule"),"."),(0,r.kt)("h3",{id:"cron-rules-static-events"},"Cron rules (static events)\u200b"),(0,r.kt)("p",null,"Let's create a cron rule that triggesr a batch job to run once every minute."),(0,r.kt)("p",null,"The batch job will generate a position report as a csv for each counterparty. This will be stored in ",(0,r.kt)("strong",{parentName:"p"},"runtime/position-minute-report"),". The file name of each report written will have the form COUNTERPARTY_ID-DATE.csv."),(0,r.kt)("h4",{id:"the-rule"},"The rule"),(0,r.kt)("p",null,"Our cron rule takes the following form:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"CRON_EXPRESSION"),(0,r.kt)("th",{parentName:"tr",align:null},"DESCRIPTION"),(0,r.kt)("th",{parentName:"tr",align:null},"TIME_ZONE"),(0,r.kt)("th",{parentName:"tr",align:null},"RULE_STATUS"),(0,r.kt)("th",{parentName:"tr",align:null},"NAME"),(0,r.kt)("th",{parentName:"tr",align:null},"USER_NAME"),(0,r.kt)("th",{parentName:"tr",align:null},"PROCESS_NAME"),(0,r.kt)("th",{parentName:"tr",align:null},"MESSAGE_TYPE"),(0,r.kt)("th",{parentName:"tr",align:null},"RESULT_EXPRESSION"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"0 45 7 ? ",(0,r.kt)("em",{parentName:"td"}," MON,TUE,WED,THU,FRI ")),(0,r.kt)("td",{parentName:"tr",align:null},"It\u2019s a rule"),(0,r.kt)("td",{parentName:"tr",align:null},"Europe/London"),(0,r.kt)("td",{parentName:"tr",align:null},"ENABLED"),(0,r.kt)("td",{parentName:"tr",align:null},"A rule"),(0,r.kt)("td",{parentName:"tr",align:null},"JaneDee"),(0,r.kt)("td",{parentName:"tr",align:null},"ALPHA_EVENTHANDLER"),(0,r.kt)("td",{parentName:"tr",align:null},"EVENT_POSITION_REPORT"),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("p",null,"Let's look at the most important fields:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"RULE_STATUS")," can be ",(0,r.kt)("strong",{parentName:"li"},"ENABLED")," or ",(0,r.kt)("strong",{parentName:"li"},"DISABLED"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"CRON_EXPRESSION")," determines when the rule is evaluated."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"PROCESS_NAME")," is the target process for the rule. When the rule is triggered, it will send a message to the process specified here."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"MESSAGE_TYPE")," is the message that needs to be sent to the specified ",(0,r.kt)("strong",{parentName:"li"},"PROCESS_NAME"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"RESULT_EXPRESSION")," is the value or values that will be sent as part of the transaction to the target PROCESS_NAME; we can leave RESULT_EXPRESSION empty, as we are going to generate a report for all positions anyway.")),(0,r.kt)("h4",{id:"1-configure-the-evaluator"},"1. Configure the Evaluator"),(0,r.kt)("p",null,"An Evaluator is a process that runs cron jobs.\nTo start, create a process called ",(0,r.kt)("em",{parentName:"p"},"GENESIS_EVALUATOR")," and add it to the file ",(0,r.kt)("strong",{parentName:"p"},"alpha-processes.xml")," inside your project folder ",(0,r.kt)("strong",{parentName:"p"},"server/jvm/alpha-config/src/main/resources/cfg")," as the code below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<processes>\n    ...\n    <process name="ALPHA_EVALUATOR">\n        <start>true</start>\n        <groupId>ALPHA</groupId>\n        <options>-Xmx512m -DXSD_VALIDATE=false</options>\n        <module>genesis-evaluator</module>\n        <primaryOnly>true</primaryOnly>\n        <package>global.genesis.eventhandler,global.genesis.evaluator</package>\n        <description>Dynamic/time rules engine</description>\n    </process>\n</processes>\n')),(0,r.kt)("p",null,"Add the ",(0,r.kt)("em",{parentName:"p"},"ALPHA_EVALUATOR")," in the file ",(0,r.kt)("strong",{parentName:"p"},"alpha-service-definitions.xml")," inside your project folder ",(0,r.kt)("strong",{parentName:"p"},"server/jvm/alpha-config/src/main/resources/cfg")," with the code below. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<configuration>\n    ...\n    <service host="localhost" name="ALPHA_EVALUATOR" port="11003"/>\n</configuration>\n')),(0,r.kt)("p",null,"Run ",(0,r.kt)("a",{parentName:"p",href:"/getting-started/developer-training/training-content-day1/#5-build-process"},"build")," and ",(0,r.kt)("a",{parentName:"p",href:"/getting-started/developer-training/training-content-day1/#deploying-the-alpha-product"},"deploy")," tasks to verify that the new process works as expected."),(0,r.kt)("p",null,"Run ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/#mon-script"},"mon"),". You should be able to see the process is present, but on ",(0,r.kt)("inlineCode",{parentName:"p"},"Standby"),".\n",(0,r.kt)("img",{src:n(60582).Z,width:"1891",height:"756"})),(0,r.kt)("p",null,"This is because the Evaluator process is set to run only on the primary node. Our application only has one node, but we still have to identify it as the Primary node."),(0,r.kt)("p",null,"Run ",(0,r.kt)("a",{parentName:"p",href:"/operations/clustering/clusters/#set-the-primary-node"},"SetPrimary")," and you should be able to see all processes running."),(0,r.kt)("h4",{id:"2-create-a-new-class"},"2. Create a new class"),(0,r.kt)("p",null,"When the evaluator is running, create a PositionReport class to trigger the new event. This class should be created inside your project folder ",(0,r.kt)("strong",{parentName:"p"},"server/jvm/alpha-messages/src/main/kotlin/global/genesis/alpha/message/event")," as the code below. "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},"package global.genesis.alpha.message.event\n\nclass PositionReport\n")),(0,r.kt)("h4",{id:"3-create-an-event-handler"},"3. Create an event handler"),(0,r.kt)("p",null,"Create an event handler that will write the csv files to the runtime/position-minute-report folder. Call it EVENT_POSITION_REPORT."),(0,r.kt)("p",null,"Open the file ",(0,r.kt)("strong",{parentName:"p"},"alpha-eventhandler.kts")," and add a variable called ",(0,r.kt)("em",{parentName:"p"},"tradeViewRepo")," injecting the class ",(0,r.kt)("em",{parentName:"p"},"TradeViewAsyncRepository"),". Then, add an event handler to generate the csv file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin",metastring:"{8,12}","{8,12}":!0},'import java.io.File\nimport java.time.LocalDate\nimport global.genesis.TradeStateMachine\nimport global.genesis.commons.standards.GenesisPaths\nimport global.genesis.gen.view.repository.TradeViewAsyncRepository\nimport global.genesis.jackson.core.GenesisJacksonMapper\n\nval tradeViewRepo = inject<TradeViewAsyncRepository>()\n\neventHandler {\n //... other event handlers removed for clarity\n     eventHandler<PositionReport> {\n        onCommit {\n            val mapper = GenesisJacksonMapper.csvWriter<TradeView>()\n            val today = LocalDate.now().toString()\n            val positionReportFolder = File(GenesisPaths.runtime()).resolve("position-minute-report")\n            if (!positionReportFolder.exists()) positionReportFolder.mkdirs()\n\n            tradeViewRepo.getBulk()\n                .toList()\n                .groupBy { it.counterpartyName }\n                .forEach { (counterParty, trades) ->\n                    val file = positionReportFolder.resolve("${counterParty}_$today.csv")\n                    if (file.exists()) file.delete()\n                    mapper.writeValues(file).use { it.writeAll(trades) }\n                }\n\n            ack()\n        }\n    }\n}\n')),(0,r.kt)("h4",{id:"4load-the-cron-rule-on-to-the-database"},"4.Load the cron rule on to the database"),(0,r.kt)("p",null,"Load the cron rule csv below into the database, ",(0,r.kt)("a",{parentName:"p",href:"/server/evaluator/basics/#cron_rule-table"},"CRON_RULE")," Table. "),(0,r.kt)("p",null,"Run ",(0,r.kt)("inlineCode",{parentName:"p"},"SendIt"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csv"},'CRON_EXPRESSION,DESCRIPTION,TIME_ZONE,RULE_STATUS,NAME,USER_NAME,PROCESS_NAME,MESSAGE_TYPE\n"0 * * * * *","It\u2019s a rule","Europe/London","ENABLED","A rule","JaneDee","ALPHA_EVENT_HANDLER","EVENT_POSITION_REPORT"\n')),(0,r.kt)("h4",{id:"5change-the-log-level-to-verify-the-execution-of-the-events"},"5.Change the log level to verify the execution of the events"),(0,r.kt)("p",null,"To do this, run the ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/#loglevel-script"},"LogLevel")," command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"LogLevel -p GENESIS_EVALUATOR -DATADUMP_ON -l DEBUG\n")),(0,r.kt)("p",null,"And then to see the logs run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd $L\ntail -f GENESIS_EVALUATOR.log\n")),(0,r.kt)("admonition",{title:"What is $L?",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"$L is an alias to the logs folder (~/run/runtime/logs) provided by the Genesis Platform. Feel free to use your favorite command to view logs such as tail, less etc.")),(0,r.kt)("h3",{id:"exercise-51-using-the-evaluator"},"Exercise 5.1: using the Evaluator"),(0,r.kt)("admonition",{title:"ESTIMATED TIME",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"30 mins")),(0,r.kt)("p",null,"Now we want to run PositionReport every 10 seconds. To do that, remove the row you just inserted in ",(0,r.kt)("a",{parentName:"p",href:"/server/evaluator/basics/#cron_rule-table"},"CRON_RULE")," table, and insert a new role changing the CRON_EXPRESSION value. "),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"To delete rows you can use ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/#dbmon-script"},"DbMon")," and the command ",(0,r.kt)("inlineCode",{parentName:"p"},"delete"),". After that you can use ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/#sendit-script"},"SendIt")," to insert a new row again."),(0,r.kt)("p",{parentName:"admonition"},"By the way, the CRON expression for every 10 seconds is ",(0,r.kt)("inlineCode",{parentName:"p"},"0/10 0 0 ? * * *"),". See a CRON generator ",(0,r.kt)("a",{parentName:"p",href:"https://www.freeformatter.com/cron-expression-generator-quartz.html"},"here"),".")),(0,r.kt)("h2",{id:"permissions"},"Permissions\u200b"),(0,r.kt)("p",null,"At this stage, the app has a Consolidator to calculate the positions, Event Handlers to control changes to the database and Data Servers and Request Servers to distribute the data to the front end."),(0,r.kt)("p",null,"For this part of the tutorial, you want to permission users so that each one has access to the correct parts of the system."),(0,r.kt)("h3",{id:"authorisation"},"Authorisation"),(0,r.kt)("p",null,"Authorisation is achieved by permissioning dynamically. This means you can control access to information in increasingly precise ways, for example:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The whole entity"),(0,r.kt)("li",{parentName:"ul"},"Specific rows"),(0,r.kt)("li",{parentName:"ul"},"Specific columns")),(0,r.kt)("p",null,"Effectively, you have two levels of control:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"High-level")),(0,r.kt)("p",null,"You could hide an entire grid from the UI, for example. So, one group of users could view reference data, but other groups would not see this. Or, you could hide an entire data server. To achieve this, you use RIGHT_CODE. This is like a switch \u2013 you can either see it or not, depending on whether the code is TRUE or FALSE."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Entity-level")),(0,r.kt)("p",null,"This is row- or column-level access to information. Different users can all view the same grid, but each one sees different data. This is best explained with these simple examples:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"You can have user A, user B and user C all having the RIGHT_CODE to view a specific grid, but each one sees different trades in that grid. This enables you to separate different trading desks, for example."),(0,r.kt)("li",{parentName:"ul"},"Each user might only have access to trades for specific customers.")),(0,r.kt)("p",null,"By including these permissions in an Event Handler, user A can only enter a trade on behalf of a specific set of clients, and user B can only enter trades on behalf of a different set of clients."),(0,r.kt)("p",null,"Similarly, you can have different users seeing different columns in the same grid. This could be used for a support function, for example. You can prevent the support team from seeing specific columns of sensitive data, such as who the client for a trade is. This can be specified by using GPAL."),(0,r.kt)("h4",{id:"users-profiles-and-right-codes"},"Users, profiles and right codes"),(0,r.kt)("p",null,"Genesis has the concept of users, profiles and right codes. For each one, there is a table to store the related entity data:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"USER"),(0,r.kt)("li",{parentName:"ul"},"PROFILE"),(0,r.kt)("li",{parentName:"ul"},"RIGHT")),(0,r.kt)("p",null,"Users gain rights via profiles. So we have tables to determine which users and rights belong to each given profile. Note that you cannot allocate right codes directly to a specific user. However, a user can have multiple profiles."),(0,r.kt)("p",null,"A profile can have zero or more rights and zero or more users."),(0,r.kt)("p",null,"These relationships are held in the following tables:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"PROFILE_RIGHT"),(0,r.kt)("li",{parentName:"ul"},"PROFILE_USER")),(0,r.kt)("p",null,"Related to these tables, we have the RIGHT_SUMMARY table, which contains the superset of rights any given user has. These are based on the profiles assigned to them. This is the key table used when checking rights, and it exists to allow the efficient checking of a user's rights."),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(43340).Z,width:"931",height:"207"})),(0,r.kt)("p",null,"The RIGHT_SUMMARY table entries are automatically maintained by the system in real time. In this way, the rights are easily accessible at speed. The GENESIS_AUTH_MANAGER process manages this table's entries automatically. So if you add a new user or you update a profile with new rights, the RIGHT_SUMMARY table is updated immediately and all the users in that profile receive the new right automatically."),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"This table is only automatically maintained when profile user/right entries are maintained via GENESIS_AUTH_MANAGER business events. If you update the data in the tables PROFILE_USER or PROFILE_RIGHT via other means (e.g. ",(0,r.kt)("strong",{parentName:"p"},"DbMon")," or ",(0,r.kt)("strong",{parentName:"p"},"SendIt"),") then the RIGHT_SUMMARY table will not be maintained automatically.\nIn such situations (e.g. setting up a brand new environemnt and bulk loading data into the tables) then the ",(0,r.kt)("inlineCode",{parentName:"p"},"~/run/auth/scripts/ConsolidateRights.sh")," script must be run. This scans all entries in PROFILE_USER and PROFILE_RIGHT and populates RIGHT_SUMMARY withe the correct data.")),(0,r.kt)("p",null,"Further information as well as a sample system set-up can be found ",(0,r.kt)("a",{parentName:"p",href:"/server/access-control/authorisation/#sample-explanation"},"here")),(0,r.kt)("h3",{id:"the-objective"},"The objective"),(0,r.kt)("p",null,"The objective is to use dynamic permissions and permission codes so that specific users have access to specific parts of the application \u2013 both functions and data."),(0,r.kt)("h3",{id:"set-up-generic-permissions"},"Set up generic permissions"),(0,r.kt)("p",null,"First, you are going to make the COUNTERPARTY table and COUNTERPARTY_ID field part of the ",(0,r.kt)("a",{parentName:"p",href:"/server/access-control/authorisation-overview/#generic-permissions"},"generic permissions")," system."),(0,r.kt)("p",null,"Starting with the server, set up the USER and USER_ATTRIBUTES records for the system user JaneDee."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"If you are not sure how to read and write information from the Genesis database, see reference page covering the ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/#dbmon-script"},(0,r.kt)("inlineCode",{parentName:"a"},"DbMon"))," and ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/#sendit-script"},(0,r.kt)("inlineCode",{parentName:"a"},"SendIt"))," commands.")),(0,r.kt)("p",null,"Set two new key values in ",(0,r.kt)("strong",{parentName:"p"},"site-specific/cfg/genesis-system-definition.kts")," file. This enables the COUNTERPARTY table and COUNTERPARTY_ID field to become part of the generic permissions system:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'item(name = "ADMIN_PERMISSION_ENTITY_TABLE", value = "COUNTERPARTY")\n\nitem(name = "ADMIN_PERMISSION_ENTITY_FIELD", value = "COUNTERPARTY_ID")\n')),(0,r.kt)("h3",{id:"configure-dynamic-permissions"},"Configure dynamic permissions"),(0,r.kt)("p",null,"You can now configure dynamic permissions for trades in our IDE. You need to make these changes to the code for the Request Server, Data Server and Event Handler.\nFor example, here we add permissioning to a query in the data server file - ",(0,r.kt)("em",{parentName:"p"},"alpha-dataserver.kts"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'dataServer {\n    query("ALL_TRADES", TRADE_VIEW) {\n        permissioning {\n            auth(mapName = "ENTITY_VISIBILITY") {\n                TRADE_VIEW.COUNTERPARTY_ID\n            }\n        }\n    }\n}\n')),(0,r.kt)("p",null,"You can add similar code to the queries in your Request Server - ",(0,r.kt)("em",{parentName:"p"},"alpha-reqrep.kts"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'requestReplies {\n    requestReply("TRADE", TRADE_VIEW) {\n        permissioning {\n            auth(mapName = "ENTITY_VISIBILITY") {\n                TRADE_VIEW.COUNTERPARTY_ID\n            }\n        }\n    }\n}\n')),(0,r.kt)("p",null,"Event Handlers are slightly different, because the input data class can be customised. The code would look like this (taking the TRADE_INSERT event handler as an example):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'  eventHandler<Trade>(name = "TRADE_INSERT") {\n    permissions {\n      auth(mapName = "ENTITY_VISIBILITY") {\n        field { counterpartyId }\n      }\n    }\n    onValidate { event ->\n      val message = event.details\n      verify {\n        entityDb hasEntry Counterparty.ById(message.counterpartyId)\n        entityDb hasEntry Instrument.ById(message.instrumentId)\n      }\n      ack()\n    }\n    onCommit { event ->\n      val trade = event.details\n      stateMachine.insert(trade)\n      ack()\n    }\n  }\n')),(0,r.kt)("h3",{id:"permissioning-and-permissioncodes"},"Permissioning and permissionCodes"),(0,r.kt)("p",null,"As with other GPAL files (e.g. Request Server and Data Server), you can use a ",(0,r.kt)("inlineCode",{parentName:"p"},"permissioning")," block to define both dynamic permissions (AUTH) and fixed permissions (based on RIGHT_SUMMARY rights) if the event message type is a generated database entity. See the example below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'    eventHandler<Company>(name = "AUTH_COMPANY_INSERT") {\n        permissioning {\n            auth(mapName = "COMPANY"){\n                COMPANY.COMPANY_NAME\n            }\n        }\n\n        onCommit { event ->\n            val company = event.details\n            val result = entityDb.insert(company)\n            ack(listOf(mapOf("VALUE" to result.record.companyId)))\n        }\n    }\n')),(0,r.kt)("p",null,"If your message type is not a database-generated entity,  you can still define fixed ",(0,r.kt)("inlineCode",{parentName:"p"},"permissionCodes")," outside the permissioning block:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'    eventHandler<Company>(name = "AUTH_COMPANY_INSERT") {\n        permissionCodes = listOf("INSERT_TRADE")\n        onCommit { event ->\n            val company = event.details\n            val result = entityDb.insert(company)\n            ack(listOf(mapOf("VALUE" to result.record.companyId)))\n        }\n    }\n')),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"/server/access-control/authorisation/"},"here")," "," for more details on authorisation."),(0,r.kt)("p",null,"After the configurations, you should execute the Genesis set-up tasks ",(0,r.kt)("strong",{parentName:"p"},"setupEnvironment"),", ",(0,r.kt)("strong",{parentName:"p"},"install-auth-distribution")," and ",(0,r.kt)("strong",{parentName:"p"},"install-alpha-site-specific-1.0.0-SNAPSHOT-bin.zip-distribution.zip")," to prepare the database for permission. Then run ",(0,r.kt)("strong",{parentName:"p"},"assemble")," and ",(0,r.kt)("strong",{parentName:"p"},"deploy-genesisproduct-alpha")," tasks again to deploy the new version."),(0,r.kt)("p",null,"Using the command ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/#dbmon-script"},(0,r.kt)("inlineCode",{parentName:"a"},"SendIt")),", make the following three configurations below."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Add the permission to the user JaneDee to use the table USER_ATTRIBUTES.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"USER_NAME,USER_TYPE,ACCESS_TYPE,COUNTERPARTY_ID\nJaneDee,USER,ENTITY,1\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Add the association between User and Counterparty to the table USER_COUNTERPARTY_MAP.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"USER_NAME,COUNTERPARTY_ID\nJaneDee,1\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Add the authorization code to the table RIGHT_SUMMARY.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"USER_NAME,RIGHT_CODE\nJaneDee,TRADER\n")),(0,r.kt)("p",null,"That is it! You can now insert some trades and see the permissions happening in the application."),(0,r.kt)("h3",{id:"exercise-52-using-permissions"},"Exercise 5.2: using permissions"),(0,r.kt)("admonition",{title:"ESTIMATED TIME",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"30 mins")),(0,r.kt)("p",null,"Set up a permission code for Trade inserting. The permission code should be called ",(0,r.kt)("em",{parentName:"p"},"TRADE_INSERT")," and be part of the ",(0,r.kt)("strong",{parentName:"p"},"alpha-eventhandler.kts")," file accordingly."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Remember to change the ",(0,r.kt)("strong",{parentName:"p"},"alpha-eventhandler.kts")," file, as well as inserting the record via ",(0,r.kt)("inlineCode",{parentName:"p"},"SendIt")," command in the configuration table ",(0,r.kt)("em",{parentName:"p"},"RIGHT_SUMMARY")," too."),(0,r.kt)("p",{parentName:"admonition"},"After the configurations, you should run ",(0,r.kt)("strong",{parentName:"p"},"assemble")," and ",(0,r.kt)("strong",{parentName:"p"},"deploy-genesisproduct-alpha")," tasks again to deploy the new version.")),(0,r.kt)("h3",{id:"application-is-done"},"Application is done!"),(0,r.kt)("p",null," Congratulations! You have finished the Positions & Trades app!"),(0,r.kt)("h2",{id:"operating-the-genesis-low-code-platform"},"Operating the Genesis low-code platform"),(0,r.kt)("p",null,"Now that our application code is complete, let's take a look at the operations side of the platform on the server."),(0,r.kt)("h3",{id:"basic-file-structure"},"Basic file structure"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"~/run/ -> /data/2022-05-23/\n\u251c\u2500\u2500 auth\n\u2502\xa0\xa0 \u251c\u2500\u2500 bin\n\u2502\xa0\xa0 \u251c\u2500\u2500 cfg\n\u2502\xa0\xa0 \u251c\u2500\u2500 lib\n\u2502\xa0\xa0 \u2514\u2500\u2500 scripts\n\u251c\u2500\u2500 alpha\n\u2502\xa0\xa0 \u251c\u2500\u2500 bin\n\u2502\xa0\xa0 \u251c\u2500\u2500 cfg\n\u2502\xa0\xa0 \u251c\u2500\u2500 lib\n\u2502\xa0\xa0 \u2514\u2500\u2500 scripts\n\u251c\u2500\u2500 genesis\n\u2502\xa0\xa0 \u251c\u2500\u2500 bin\n\u2502\xa0\xa0 \u251c\u2500\u2500 cfg\n\u2502\xa0\xa0 \u251c\u2500\u2500 lib\n\u2502\xa0\xa0 \u251c\u2500\u2500 scripts\n\u2502\xa0\xa0 \u2514\u2500\u2500 util\n\u251c\u2500\u2500 generated\n\u2502\xa0\xa0 \u251c\u2500\u2500 cfg\n\u2502\xa0\xa0 \u251c\u2500\u2500 classes\n\u2502\xa0\xa0 \u251c\u2500\u2500 genesis-generated-[...]\n\u2502\xa0\xa0 \u2514\u2500\u2500 sources\n\u251c\u2500\u2500 runtime\n\u2502\xa0\xa0 \u251c\u2500\u2500 [...]\n\u2502\xa0\xa0 \u251c\u2500\u2500 logs\n\u2514\u2500\u2500 site-specific\n    \u251c\u2500\u2500 bin\n    \u251c\u2500\u2500 cfg\n    \u251c\u2500\u2500 lib\n    \u2514\u2500\u2500 scripts\n")),(0,r.kt)("p",null,"Understanding the file structure:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"run")," is what we usually call the installation directory, which is preferentially a symlink to another folder named as the date of creation. It makes upgrading easier, so we can just point the ",(0,r.kt)("inlineCode",{parentName:"li"},"run")," folder to a new folder like ",(0,r.kt)("inlineCode",{parentName:"li"},"2023-01-01")," running a new version of the platform."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"auth"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"alpha"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"genesis")," are application modules, and they contain the same structure, with sub-folders like ",(0,r.kt)("inlineCode",{parentName:"li"},"bin"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"cfg"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"lib")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"scripts"),". If you add a new module, ",(0,r.kt)("inlineCode",{parentName:"li"},"market_data")," for example, it would be another folder under ",(0,r.kt)("inlineCode",{parentName:"li"},"run")," with the same structure as the other modules. You can deploy a new module by unzipping the module's distribution zip file into the ",(0,r.kt)("inlineCode",{parentName:"li"},"run")," folder and running ",(0,r.kt)("inlineCode",{parentName:"li"},"genesisInstall"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"generated")," contains files processed and installed by the platform. Do ",(0,r.kt)("strong",{parentName:"li"},"not")," change its content manually (use the ",(0,r.kt)("inlineCode",{parentName:"li"},"genesisInstall")," command instead)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"runtime")," contains important files used by the platform at run time. Do ",(0,r.kt)("strong",{parentName:"li"},"not")," change its content manually, but use commands like ",(0,r.kt)("inlineCode",{parentName:"li"},"ClearCodegenCache")," (if you run into problems updating the data model) to manage some of its content. The ",(0,r.kt)("inlineCode",{parentName:"li"},"logs")," folder contains all the logs, including logs from your modules (such as ",(0,r.kt)("inlineCode",{parentName:"li"},"alpha"),") and from the platform itself."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"site-specific")," is very useful when you want to override files from standard modules, such as ",(0,r.kt)("inlineCode",{parentName:"li"},"genesis")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"auth"),".")),(0,r.kt)("p",null,"A more detailed explanation on the file structure can be found here. "),(0,r.kt)("h3",{id:"key-server-commands"},"Key server commands"),(0,r.kt)("p",null,"So far, we've used commands such as ",(0,r.kt)("inlineCode",{parentName:"p"},"mon"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"DbMon"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"SendIt")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"LogLevel"),". There are quite a few more important commands to help you operate the Genesis Platform:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/operations/commands/server-commands/#genesisinstall-script"},"genesisInstall")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/operations/commands/server-commands/#remap-script"},"remap")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/operations/commands/server-commands/"},"starting and stopping the server")," "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/operations/commands/server-commands/#dumpit-script"},"DumpIt")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/operations/commands/server-commands/#droptable"},"DropTable"))),(0,r.kt)("h3",{id:"practising-the-commands"},"Practising the commands"),(0,r.kt)("p",null,"Let's do a manual deployment of the tables dictionary as an example of how to run the server commands."),(0,r.kt)("p",null,"From the terminal, go to the folder ",(0,r.kt)("inlineCode",{parentName:"p"},"/home/genesis/run/alpha/cfg/"),", edit file ",(0,r.kt)("inlineCode",{parentName:"p"},"alpha-tables-dictionary.kts")," and add any existing field to table INSTRUMENT_PRICE."),(0,r.kt)("p",null,"Now, go to the ",(0,r.kt)("inlineCode",{parentName:"p"},"generated")," folder with ",(0,r.kt)("inlineCode",{parentName:"p"},"cd $GC")," (an alias to the ",(0,r.kt)("inlineCode",{parentName:"p"},"generated")," folder). Compare the content between the file you edited previously with the one you see in the ",(0,r.kt)("inlineCode",{parentName:"p"},"generated")," folder. The one in $GC does not contain your change."),(0,r.kt)("p",null,"Next, run ",(0,r.kt)("inlineCode",{parentName:"p"},"genesisInstall")," and then compare again the files - you'll notice now they are identical because ",(0,r.kt)("inlineCode",{parentName:"p"},"genesisInstall")," processed and installed it into the ",(0,r.kt)("inlineCode",{parentName:"p"},"generated")," folder. Without running ",(0,r.kt)("inlineCode",{parentName:"p"},"genesisInstall"),", it would use an older version of the file."),(0,r.kt)("p",null,"Since this is a table change, we need to install the changes in the database. So, let's stop the server, back up the table data and run ",(0,r.kt)("inlineCode",{parentName:"p"},"remap"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"cd /tmp\nkillServer --all\nDumpIt -t INSTRUMENT_PRICE\nremap --commit\nDbMon\n >table INSTRUMENT_PRICE\n >show\n >exit\nstartServer\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"When deploying files manually like this, remember to push the change to version control as well, otherwise the next deployment will override the changes. Ideally, you'd change the file first in your IDE and then copy it to the server and run the commands. ")),(0,r.kt)("p",null,"An exhaustive list of commands can be found ",(0,r.kt)("a",{parentName:"p",href:"/operations/commands/server-commands/"},"here"),". "),(0,r.kt)("h3",{id:"exercise-53-manual-deployment-of-the-application-distribution"},"Exercise 5.3: manual deployment of the application distribution"),(0,r.kt)("admonition",{title:"ESTIMATED TIME",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"30 mins")),(0,r.kt)("p",null,"Add some logging to TRADE_INSERT event handler onCommit method with INFO level:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-kotlin"},'eventHandler<Trade>(name = "TRADE_INSERT") {\n        ...\n        onCommit { event ->\n            LOG.info("Awesome log")\n            ...\n        }\n    }\n...\n')),(0,r.kt)("p",null,"Next, build the application as you usually do."),(0,r.kt)("p",null,"Then copy the ",(0,r.kt)("inlineCode",{parentName:"p"},"genesisproduct-alpha-1.0.0-SNAPSHOT-bin.zip")," from .\\server\\jvm\\alpha-distribution\\build\\distributions\\ to the /home/genesis/run/ folder in the server (i.e., your WSL instance, where you can access its file system from Windows Explorer navigating to ",(0,r.kt)("inlineCode",{parentName:"p"},"\\\\wsl$"),")."),(0,r.kt)("p",null,"Once the zip file is in the ~/run/ folder, unzip it (use unzip command) and run ",(0,r.kt)("inlineCode",{parentName:"p"},"killServer --all"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"genesisInstall"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"remap --commit"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"startServer"),"."),(0,r.kt)("p",null,"Change the log level of the ALPHA_EVENT_HANDLER process to INFO with ",(0,r.kt)("inlineCode",{parentName:"p"},"LogLevel")," and insert a new trade from the UI."),(0,r.kt)("p",null,"To test it, check if you can see the new log you added in the alpha event handler log file."),(0,r.kt)("h2",{id:"navigating-the-documentation-and-how-to-get-help"},"Navigating the documentation and how to get help\u200b"),(0,r.kt)("p",null,"Remember that the Search function in the documentation is your friend."),(0,r.kt)("p",null,"A new developer portal is on the way with features such as forum (internal Stack overflow), technical blogs, articles and more detailed documentation. "),(0,r.kt)("p",null,"Stay tuned!"))}c.isMDXComponent=!0},60582:function(e,t,n){t.Z=n.p+"assets/images/standbysmall-alpha-4bbd948b9388eff9697e78d7bdeb8cf1.png"},43340:function(e,t,n){t.Z=n.p+"assets/images/user-profile-rights-setup-3dacd0ceee33f5777ecffe47e3a4b162.png"}}]);