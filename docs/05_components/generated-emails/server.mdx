---
title: 'Email Generation'
sidebar_label: 'Email Generation'
sidebar_position: 3
id: generated-emails-server
keywords: [components, email, generation]
tags:
  - components
  - email
  - generation
---

## Introduction
This feature enables you to generate email bodies using predefined HTML templates. This can also include information from your application's database as well as embedded images.

Behind the scenes, the email builder is using the [Document Generator](../../generated-docs/generated-docs-server) to create the email bodies. After creating and uploading the template and the assets to FILE_STORAGE (see Document Management for more information on uploading/downloading files), you will be able to use these to generate your email bodies.

There are two gateways you can use:
- SMTP (Simple Mail Transfer Protocol)
- SendGrid

## Configuration
In order to send out emails, you will need to ensure that the following configuration for [Email](../../notifications/notifications-server/email/#email-gateway-configuration)/[SendGrid](../../notifications/notifications-server/email/#sendgrid-gateway-configuration) gateway and the [database](../../notifications/notifications-server/email/#database-configuration) is set up in your application.

The same email template will work with both gateways.

## HTML templates

### Sourced data to be displayed in the email

```html
<tbody>
    <tr>
        <td th:text="${trade.price}">1.00</td>
        <td th:text="${trade.quantity}">1000</td>
        <td th:text="${trade.counterparty}">Counterparty1</td>
        <td th:text="${trade.side}">BUY</td>
        <td th:text="${trade.account}">Account1</td>
    </tr>
</tbody>
```

### Embedded images

These can be referenced in the HTML template with the name of the file. This needs to be uploaded to the file storage beforehand.
```html
<img
    src="./genesis-logo.png"
    alt="Logo"
    width="140"
    style="max-width: 140px; width: 100%; display: block; border: 0px; height: auto !important;"
/>
```

# CSS
The styling should be defined inline in the HTML template. External CSS files are not yet supported by this feature.

## How to trigger emails

### Email Templates in an Event Handler

This example uses a Notify insert with an [Event Handler](../../../../server/event-handler/basics) file.

- `documentId` is the file storage id of the email attachment (stored in the FILE_STORAGE table). If left blank, no file will be attached.
- `templateRef` is the email template reference (FILE_STORAGE id or the name of the file including the extension). If left blank, the 'body' field will be used to populate the email.
- `tableName` is the table name which sources the data to be shown in the email. This can be null.
- `tableEntityId` is the id of the record in the aforementioned table. This can be null.

```kotlin
eventHandler<EmailGeneratorData>(name = "GENERATE_EMAIL") {
        onValidate {
            ack()
        }

        onCommit { event ->
            val details = event.details

            val notify = Notify {
                this.body = details.body
                this.header = details.header
                this.documentId = details.fileStorageId
                this.notifySeverity = NotifySeverity.Information
                this.tableEntityId = details.tableEntityId
                this.tableName = details.tableName
                this.templateRef = details.emailTemplateRef
                this.topic = details.topic
            }

            val messageClient = serviceDiscovery.resolveClientByResource("EVENT_NOTIFY_INSERT")
            messageClient!!.sendMessage(
                Event (
                    details = notify,
                    messageType = "EVENT_NOTIFY_INSERT",
                    userName = event.userName
                )
            )

            // custom code block ...

            ack()
        }
    }
```

This example uses a Notify insert with an [Event Handler](../../../../server/event-handler/basics) file where the attachment is generated by the Document Generator. The `documentId` field needs to be populated with the fileStorageId of the pdf.
```kotlin
eventHandler<EmailGeneratorData>(name = "GENERATE_EMAIL_AND_PDF") {
        onValidate {
            ack()
        }

        onCommit { event ->
            val details = event.details
            val user = entityDb.get(User.byName(details.userName))
            val userAtt = entityDb.get(UserAttributes.byUserName(details.userName))
            val allTradesByUser = entityDb.getBulk(TRADE).toList().filter { it.enteredBy == details.userName }

            val contextMap : MutableMap<String, Any> = mutableMapOf(
                "trades" to allTradesByUser
            )

            if (user != null) {
                contextMap["user"] = user
            }

            if (userAtt != null) {
                contextMap["userAtt"] = userAtt
            }

            val config = DocumentStorageConfiguration(
                templateId = details.pdfTemplateId,
                fileName = "user-trades-${details.userName}.pdf",
                userName = event.userName,
                data = contextMap,
                deleteOnExit = true,
            )
            val pdf = documentGenerator.generateAndStore(config)

            val notify = Notify {
                this.body = details.body
                this.header = details.header
                this.documentId = pdf.fileStorageId
                this.notifySeverity = NotifySeverity.Information
                this.tableEntityId = details.tableEntityId
                this.tableName = details.tableName
                this.templateRef = details.emailTemplateRef
                this.topic = details.topic
            }

            val messageClient = serviceDiscovery.resolveClientByResource("EVENT_NOTIFY_INSERT")
            messageClient!!.sendMessage(
                Event (
                    details = notify,
                    messageType = "EVENT_NOTIFY_INSERT",
                    userName = event.userName
                )
            )
            ack()
        }
    }
```

As shown above, all the data from the database needs to be added to the context map. The key of each object in the map must correspond to a placeholder in the HTML template:
```html
<tr>
    <td style="padding-top: 20px;">
        <h1 th:text="${user.firstName} + ' ' + ${user.lastName}" style="font-size: 12px; font-weight: 700; margin: 0;">Username</h1>
        <p th:text="${userAtt.addressLine1}" style="font-size: 12px; margin: 8px 0 0 0; padding: 0; color: #929292;">Address Line 1</p>
        <p th:text="${userAtt.addressLine2}" style="font-size: 12px; margin: 8px 0 0 0; padding: 0; color: #929292;">Address Line 2</p>
        <p th:text="${userAtt.postalCode}" style="font-size: 12px; margin: 8px 0 0 0; padding: 0; color: #929292;">Post/Zip Code</p>
    </td>
</tr>
<tr>
    <td style="vertical-align: top; text-align: left; padding-top: 28px;">
        <h2 style="font-weight: 700; font-size: 22px; padding: 0; margin: 0; white-space: nowrap;">Transaction Confirmation</h2>
        <p th:text="${#dates.format(#dates.createNow(), 'dd-MM-yyyy HH:mm')}" style="font-weight: 600; font-size: 16px; margin: 10px 0 0 0; padding: 0; color: #929292;"></p>
    </td>

    <td style="font-size: 16px; vertical-align: top; text-align: right; padding-top: 28px; white-space: nowrap;">
        <p th:text="${user.companyId}" style="margin: 0; padding: 0 0 8px 0;"><span style="font-weight: 700;">Company ID:</span> <span style="font-weight: 600; color: #929292;">Company ID</span></p>
        <p th:text="${user.firstName} + ' ' + ${user.lastName}" style="margin: 0; padding: 0;"><span style="font-weight: 700;">Username:</span> <span style="font-weight: 600; color: #929292;">Username</span></p>
    </td>
</tr>
<tr>
    <td colspan="2" style="padding: 20px 0;">
        <table role="presentation" cellpadding="0" cellspacing="0" style="width: 100%; border: none;">
            <tr>
                <th style="font-weight: 700; text-align: left; font-size: 14px; padding: 0 0 5px 0;">Trade ID</th>
                <th style="font-weight: 700; text-align: left; font-size: 14px; padding: 0 0 5px 0;">Date</th>
                <th style="font-weight: 700; text-align: left; font-size: 14px; padding: 0 0 5px 0;">Side</th>
                <th style="font-weight: 700; text-align: left; font-size: 14px; padding: 0 0 5px 0;">Price</th>
                <th style="font-weight: 700; text-align: left; font-size: 14px; padding: 0 0 5px 0;">Quantity</th>
            </tr>
            <tr th:each="trade : ${trades}">
                <td th:text="${trade.tradeId}" style="padding: 10px 0 0 0; text-align: left; font-size: 14px; color: #929292;">ABC123</td>
                <td th:text="${trade.tradeDatetime}" style="padding: 10px 0 0 0; text-align: left; font-size: 14px; color: #929292;">March 21, 2024</td>
                <td th:text="${trade.side}" style="padding: 10px 0 0 0; text-align: left; font-size: 14px; color: #929292;">Long Sale</td>
                <td th:text="${trade.price}" style="padding: 10px 0 0 0; text-align: left; font-size: 14px; color: #929292;">100.25</td>
                <td th:text="${trade.quantity}" style="padding: 10px 0 0 0; text-align: left; font-size: 14px; color: #929292;">100</td>
            </tr>
        </table>
    </td>
</tr>
```