---
title: 'Email Generation'
sidebar_label: 'Email Generation'
sidebar_position: 3
id: generated-emails-server
keywords: [components, email, generation]
tags:
  - components
  - email
  - generation
---

## Introduction
This feature enables you to generate email bodies using predefined HTML templates. This can also include information from your application's database as well as embedded images.

Behind the scenes, the email builder is using the [Document Generator](../../generated-docs/generated-docs-server) to create the email bodies. After creating and uploading the template and the assets to FILE_STORAGE (see Document Management for more information on uploading/downloading files), you will be able to use these to generate your email bodies.

There are two gateways you can use:
- SMTP (Simple Mail Transfer Protocol)
- SendGrid

## Configuration
In order to send out emails, you will need to ensure that the following configuration for [Email](../../notifications/notifications-server/email/#email-gateway-configuration)/[SendGrid](../../notifications/notifications-server/email/#sendgrid-gateway-configuration) gateway and the [database](../../notifications/notifications-server/email/#database-configuration) is set up in your application.

The same email template will work with both gateways.

## HTML templates

### Sourced data to be displayed in the email
For examples on how to structure the data in your HTML templates, please refer to the [Document Generator docs](../../generated-docs/generated-docs-server/#html-templates).
Please note that the data referenced in the email bodies is queried by the tableName and tableEntityId (fields explained below). At the moment you can only query a single record per email.

### Embedded images

These can be referenced in the HTML template with the name of the file. This needs to be uploaded to the file storage beforehand.
```html
<img
    src="./genesis-logo.png"
    alt="Logo"
    width="140"
    style="max-width: 140px; width: 100%; display: block; border: 0px; height: auto !important;"
/>
```

# CSS
The styling should be defined inline in the HTML template. External CSS files are not yet supported by this feature.

## How to trigger emails

### Email Templates in an Event Handler

This example uses a Notify insert with an [Event Handler](../../../../server/event-handler/basics) file.

- `documentId` is the file storage id of the email attachment (stored in the FILE_STORAGE table). If left blank, no file will be attached.
- `templateRef` is the email template reference (FILE_STORAGE id or the name of the file including the extension). If left blank, the 'body' field will be used to populate the email.
- `tableName` is the table name which sources the data to be shown in the email. This can be null.
- `tableEntityId` is the id of the record in the aforementioned table. This can be null.

```kotlin
eventHandler<EmailGeneratorData>(name = "GENERATE_EMAIL") {
        onValidate {
            ack()
        }

        onCommit { event ->
            val details = event.details

            val notify = Notify {
                this.body = details.body
                this.header = details.header
                this.documentId = details.fileStorageId
                this.notifySeverity = NotifySeverity.Information
                this.tableEntityId = details.tableEntityId
                this.tableName = details.tableName
                this.templateRef = details.emailTemplateRef
                this.topic = details.topic
            }

            val messageClient = serviceDiscovery.resolveClientByResource("EVENT_NOTIFY_INSERT")
            messageClient!!.sendMessage(
                Event (
                    details = notify,
                    messageType = "EVENT_NOTIFY_INSERT",
                    userName = event.userName
                )
            )

            // custom code block ...

            ack()
        }
    }
```
If you would like to generate the email attachment from an HTML template, you will need to include the following in the event handler:
```kotlin
    val config = DocumentStorageConfiguration(
        templateId = details.pdfTemplateId,
        fileName = "user-trades-${details.userName}.pdf",
        userName = event.userName,
        data = contextMap,
        deleteOnExit = true,
    )

    val pdf = documentGenerator.generateAndStore(config)
```
The documentId field needs to be populated then with the fileStorageId of the pdf:
```kotlin
this.documentId = pdf.fileStorageId
```
All the data from the database needs to be added to the context map. The key of each object in the map must correspond to a placeholder in the [HTML template](../../generated-docs/generated-docs-server/#html-templates).
