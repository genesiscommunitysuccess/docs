---
title: 'OTE app: improving the back end'
sidebar_label: 'Improving the back end'
id: ht-ote-improving-back-end
sidebar_position: 3
keywords: [OTE]
tags:
    - OTE
    
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


Here, we shall look into the back-end code and make some useful changes to increase the usability and range of the app.

## Adding a query
Now add a new query to your Data Server to make this information available to the front end.

1. Go to the folder `OTE\server\OTE-app\src\main\genesis\scripts`.

2. Go to the file `OTE\server\OTE-app\src\main\genesis\scripts\OTE-dataserver.kts` and add the following code [Need to specify where] to define the new query.

This can also be found in a TODO block.

```
query("ALL_USER_NAMES", USER) {
  fields {
    USER_NAME
  }
}
```

## Updating the consolidators
The code changes listed can also be found in TODO blocks.

1. Go to the file `OTE\server\OTE-app\src\main\genesis\scripts\OTE-consolidator.kts`.

2. In the `SELL_PARTICIPANT_POSITION_AGG consolidator`, find `sum { quantity } into QUANTITY`. Update it as follows:

```kotlin
sum { quantity * -1 } into QUANTITY
```

Modify the CASH_BALANCE_AGG consolidator so that the new aggregations are included as a result of the primary key changes that were made.

### Aggregate buy and sell in the consolidators
To ensure that Buy and Sell data is aggregated and captured for the correct side in the `OPEN_POSITION_AGG` consolidator:

1. Add the following code to the imports section:

```kotlin
import global.genesis.gen.dao.enums.OTE.passive_order_book.Side
import global.genesis.gen.dao.enums.OTE.passive_order_book.Status
```
2. Find `sum { openQuantity } into BUY_QUANTITY` and `sum { openQuantity } into SELL_QUANTITY`. Update as follows:

```kotlin
sum { openQuantity } onlyIf { side == Side.Buy } into BUY_QUANTITY
sum { openQuantity } onlyIf { side == Side.Sell } into SELL_QUANTITY
```
3. Find `groupBy` and add the following clause above this label:
<!-- TODO: We should be using filter instead of where now -->

```kotlin
where {
      status == Status.Active
    }
```

## Create a new passive order book eventHandler
To handle the Passive Order Book correctly, you need to update the `-eventhandler.kts` file. The file contains a list of TODO items. Each of these contains extra code. 

Go to each TODO item, copy the code from that item and insert it into the code itself.

:::tip
When you are copying and pasting the code in the TODO items, make sure you copy the complete code each time - word wrapping makes it easy to get this wrong if you have a small window.

The code snippets themselves have comments throughout to indicate the purpose of each codeblock.

:::

That's it. Once you have inserted this code, you have successfully set the logic for handling the passive order book. 
