name: Sync API Docs

on:
  schedule:
    # Run every day at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  sync-api-docs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.11.0]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --loglevel=error --no-update-notifier
      
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Run API docs sync
        id: sync
        run: |
          # Run the sync script with all git operations enabled
          # Use tee to show output in real-time and capture it
          set -o pipefail
          
          echo "ðŸš€ Starting API docs sync..."
          node scripts/sync-api-docs.js --all 2>&1 | tee sync_output.log
          
          # Check if the script succeeded
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ Sync script failed. Output:"
            cat sync_output.log
            exit 1
          fi
          
          # Extract the version from the output
          VERSION=$(grep "Latest version:" sync_output.log | sed 's/Latest version: //' | head -1)
          if [ -n "$VERSION" ]; then
            echo "âœ… Extracted version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Could not extract version from output"
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "Full output for debugging:"
            cat sync_output.log
          fi
          
          # Clean up
          rm -f sync_output.log
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check for changes
        id: check_changes
        run: |
          echo "ðŸ” Checking for changes in working directory..."
          
          # Use git diff and git status to check for changes
          git_status_output=$(git status --porcelain)
          
          if [ -n "$git_status_output" ]; then
            echo "âœ… Changes detected:"
            echo "$git_status_output"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No changes detected in working directory"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          # Also show git status for debugging
          echo ""
          echo "Full git status:"
          git status
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: sync API docs to version ${{ steps.sync.outputs.version }}'
          title: 'chore: sync API docs to version ${{ steps.sync.outputs.version }}'
          body: |
            This PR was automatically created by the API docs sync workflow.
            
            Changes:
            - Updated @genesislcap packages to version ${{ steps.sync.outputs.version }}
            - Regenerated API documentation from updated packages
            - Updated processedMap with new versions
            
            This is an automated update. Please review the changes and merge if everything looks good.
          branch: sync-api-docs-${{ github.run_id }}
          base: preprod
          delete-branch: true
          labels: |
            automated
            api-docs
            documentation
